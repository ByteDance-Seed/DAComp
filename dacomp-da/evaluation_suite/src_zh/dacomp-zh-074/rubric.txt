# [总分 | 40分] 现金流高风险公司事件窗口分析与预警设计评分标准

适用于任务：基于 /Users/bytedance/workspace/dacomp-release/dacomp-da/tasks/dacomp-074/dacomp-074.sqlite（netsuite2_financial_dashboard & netsuite2_income_statement），比较首次进入 cash_flow_risk_level='High' 之前的事件窗口（rel_month=-6…-1）与健康/基线窗口的指标轨迹，识别可提前2–3个月预警的指标组合与阈值，并给出模型化与运营落地建议。

———

## 需求1：数据整合与事件/对照队列构建（最高 8分）

### 标准1.1：字段映射与月度合并口径（最高 3分）

#### 路径1.1.A [3分 | 损益聚合 + 仪表字段对齐]
- 小标准1.1.A.1 [1分 | 完备性]：说明需读取两表核心字段：dashboard（subsidiary_id、dashboard_date、cash_flow_risk_level、net_cash_flow、operating_cash_flow、predicted_next_month_cash_flow、total_customer_revenue、overdue_percentage、weighted_average_days_outstanding）与 income（subsidiary_id、accounting_period_ending、account_type_name、converted_amount），并统一使用 `subsidiary_id + strftime('%Y-%m', …)` 作为月份键；需补充说明同一子公司同月存在多条仪表记录时需按 dashboard_date 排序保留最新记录，得到 170 条唯一公司-月份。
- 小标准1.1.A.2 [1分 | 精确性]：给出聚合 SQL/伪代码：按 `account_type_name` 聚合出 revenue/expense/cost_of_revenue，再与仪表表 LEFT JOIN；写明复核结果：10 家子公司、dashboard_date 范围 2023-01-31～2024-06-24、原始 180 行全部匹配，聚合后 170 行唯一月份中 revenue/expense 均无空值；需展示任意 1 家子公司对账示例（如 NET07583103971 2023-05 月收入=1,911,220.27 与仪表 total_customer_revenue=1,911,220.27 一致）。
- 小标准1.1.A.3 [1分 | 结论性]：写明月度基准数据集包含：损益收入/费用、仪表板 AR 指标、现金流与风险标签，是事件窗口与指标计算的唯一数据来源；若采用此口径，后续分析与可视化均需引用该 170×字段的数据框。

#### 路径1.1.B [3分 | 直接使用 total_customer_revenue]
- 小标准1.1.B.1 [1分 | 完备性]：说明在损益聚合缺失或币种差异时，可直接使用仪表字段 total_customer_revenue；同样需 `subsidiary_id + 月份` 去重，保证 170 个公司-月份；明确需同时保留 expense（若缺失可回落到 cost_of_revenue）。
- 小标准1.1.B.2 [1分 | 精确性]：描述合并步骤：仪表字段（收入、AR、风险）原生覆盖 10 家、180 行；去重后 170 行；强调需验证收入/费用字段非空，并记录差异（如 NET33975149380 2023-05 仪表收入与损益口径差异 <0.5%）。
- 小标准1.1.B.3 [1分 | 结论性]：指出不同收入口径导致波动指标差异：事件窗口 |rev_mom|>20% 占比=0.5962，而仪表口径仅 0.0962；提醒后续分析不能混用两种口径。

### 标准1.2：事件窗口与健康/基线窗口构建（最高 3分）

#### 路径1.2.A [3分 | 首次 High 事件窗]
- 小标准1.2.A.1 [1分 | 完备性]：确认每家子公司首次 High 日期（2023-07-30×3、2023-08-29×5、2023-09-28×2），并说明 rel_month 计算方式：`(year*12+month) - (first_high_year*12+first_high_month)`。
- 小标准1.2.A.2 [1分 | 精确性]：统计事件窗口样本量=52 个公司-月份（容差±1），其中 2 家子公司（首 High=2023-09-28）覆盖 6 个月，其余 8 家因 2023-02 缺失仅有 5 个月；需给出 rel_month 分布：{-6:5, -5:7, -4:10, -3:10, -2:10, -1:10}。
- 小标准1.2.A.3 [1分 | 结论性]：明确事件窗口缺口来源（历史月度缺失），后续指标计算须以 52 行样本为基准，并在结论中注明“部分子公司事件窗缺1个月”。

#### 路径1.2.B [3分 | Low 锚点健康窗]
- 小标准1.2.B.1 [1分 | 完备性]：采用“最新一次 cash_flow_risk_level='Low' 且未来3个月不为 High”作为健康锚点；共识别 8 家子公司满足条件。
- 小标准1.2.B.2 [1分 | 精确性]：受限于数据起始于 2023-01，最终仅 6 家子公司在 rel_month_healthy∈[-6,-1] 内存在观测，共 11 个公司-月份（分布：{-4:2, -3:1, -2:5, -1:3}）；需在方案中说明不足 6 个月时须保留现有月份并在评分记录中标注样本量。
- 小标准1.2.B.3 [1分 | 结论性]：强调健康窗口用于对照事件窗口的趋势形态，需在分析结论中注明“健康窗样本=11，结果仅供参考”；若健康窗缺失，则不得跳过此提示。

#### 路径1.2.C [3分 | 基线窗口（t-12…t-7）]
- 小标准1.2.C.1 [1分 | 完备性]：以 first_high_date 向前偏移 7~12 个月构建基线窗口；目前仅有 7 条公司-月份（rel=-8:2、rel=-7:5）。
- 小标准1.2.C.2 [1分 | 精确性]：说明这些月份由于缺乏前一月数据，无法计算环比；需要在报告中给出样本量及“环比指标不可得”说明，以免误判。
- 小标准1.2.C.3 [1分 | 结论性]：指出基线窗口可用于比较绝对水平（如 WADO），但对环比类指标需另行处理（如使用绝对值或跨期均值），并在结论中注明数据稀疏。

### 标准1.3：相对月份排序与差异化索引（最高 2分）

#### 路径1.3.A [2分 | rel_month/LAG 运算保障]
- 小标准1.3.A.1 [1分 | 完备性]：明确需对每家子公司按 dashboard_date 排序，使用 LAG 计算 rev_mom/exp_mom/overdue_delta 等指标；当上一期绝对值<1e-6 或缺失时需返回 NULL；最终 170 行中可计算的环比记录=160 行。
- 小标准1.3.A.2 [1分 | 精确性]：说明在事件、健康窗口内分别保留 52 与 11 行环比记录；统计各指标可用量并在结果表中展示（如事件窗 rev_mom 可用=52、dash_rev_mom 可用=52、WADO_delta 可用=52），确保后续占比计算的分母一致。

———

## 需求2：三大指标体系计算与轨迹提炼（最高 12分）

### 标准2.1：收入波动与稳定性分析（最高 4分）

#### 路径2.1.A [4分 | 损益口径收入环比]
- 小标准2.1.A.1 [1分 | 完备性]：定义 `rev_mom = (revenue_t - revenue_{t-1}) / revenue_{t-1}`，忽略上一期绝对值<1e-6 的月份；范围限定事件窗口 52 行。
- 小标准2.1.A.2 [2分 | 精确性]：|rev_mom|>20% 的月度占比必须达到事件窗口整体 0.5962（容差±0.02），逐月占比分别为：t-6=0.2000、t-5=0.5714、t-4=0.5000、t-3=0.8000、t-2=0.8000、t-1=0.5000（各容差±0.05）；同时给出命中次数 31/52 以供复核。
- 小标准2.1.A.3 [1分 | 结论性]：指出 t-3～t-2 收入波动显著抬升（≥0.8），是危险信号密集期；需结合缺失月份说明结论适用于“最近 4 个月”。

#### 路径2.1.B [4分 | 仪表板收入口径]
- 小标准2.1.B.1 [1分 | 完备性]：使用 total_customer_revenue 计算 `dash_rev_mom`，并保持与 Path2.1.A 相同的去重、LAG 规则。
- 小标准2.1.B.2 [2分 | 精确性]：|dash_rev_mom|>20% 的整体占比=0.0962（容差±0.02）；逐月占比：t-6=0.0000、t-5=0.1429、t-4=0.0000、t-3=0.1000、t-2=0.1000、t-1=0.2000（容差±0.05）；需在结果中解释损益口径与仪表口径差异≈50pp 的原因（仪表收入更平滑）。
- 小标准2.1.B.3 [1分 | 结论性]：强调若 CFO 采用仪表收入，需要额外关注收入确认滞后，否则会低估风险。

#### 路径2.1.C [4分 | 波动强度刻画]
- 小标准2.1.C.1 [1分 | 完备性]：构建“滚动3个月内≥2次 |rev_mom|>20%”指标（rev_vol_roll3_ge2）。
- 小标准2.1.C.2 [2分 | 精确性]：事件窗口整体命中率=0.4808（容差±0.02），逐月占比：t-6=0.0、t-5=0.0、t-4=0.3、t-3=0.5、t-2=0.9、t-1=0.8（容差±0.05），并给出命中次数 25/52。
- 小标准2.1.C.3 [1分 | 结论性]：说明滚动强度在 t-3/t-2 达峰，确认“连续性波动”是危机前 2 个月的显著特征。

### 标准2.2：应收账款管理维度（最高 4分）

#### 路径2.2.A [4分 | 阈值占比]
- 小标准2.2.A.1 [1分 | 完备性]：统计 weighted_average_days_outstanding（WADO）>40、>45 的占比，以及 overdue_percentage 连续上升（overdue_up）。
- 小标准2.2.A.2 [2分 | 精确性]：事件窗口 share_wado_gt40=0.1923、share_wado_gt45=0.0000、share_overdue_up=0.4615（容差各±0.02）；逐月 WADO>40 占比：t-6=0.2、t-5=0.2857、t-4=0.0、t-3=0.1、t-2=0.3、t-1=0.3；逐月 overdue_up：t-6=0.2、t-5=0.1429、t-4=0.7、t-3=0.4、t-2=0.4、t-1=0.7。
- 小标准2.2.A.3 [1分 | 结论性]：说明 45 天阈值完全不起作用，需下调至 40 天；同时强调 t-4 与 t-1 的逾期连增最显著。

#### 路径2.2.B [4分 | 动量与趋势]
- 小标准2.2.B.1 [1分 | 完备性]：构建“最近3期 WADO≥40 至少1次”（wado_gt40_recent3）与“最近3期 overdue_up≥2 次”（overdue_up_recent3）。
- 小标准2.2.B.2 [2分 | 精确性]：事件窗口 wado_gt40_recent3 占比=0.3269、overdue_up_recent3=0.2692（容差±0.02）；逐月 wado_gt40_recent3：t-4=0.3、t-3=0.4、t-2=0.6、t-1=0.6；逐月 overdue_up_recent3：t-4=0.3、t-3=0.3、t-2=0.5、t-1=0.5。
- 小标准2.2.B.3 [1分 | 结论性]：指出当动量与阈值同时命中（例：t-2），回款压力显著，需要提前加速催收。

### 标准2.3：支出控制与背离度分析（最高 4分）

#### 路径2.3.A [4分 | 增长差异阈值]
- 小标准2.3.A.1 [1分 | 完备性]：定义 divergence = exp_mom - rev_mom，统计 >10%、>15% 占比及 |divergence| 均值。
- 小标准2.3.A.2 [2分 | 精确性]：事件窗口 share_div_gt10=0.3654、share_div_gt15=0.2885、|divergence| 平均=0.3532（容差±0.02）；逐月 share_div_gt15：t-6=0.0、t-5=0.2857、t-4=0.3、t-3=0.3、t-2=0.4、t-1=0.3；说明命中次数 15/52。
- 小标准2.3.A.3 [1分 | 结论性]：指出 t-2、t-1 仍有 ≥30% 的月份支出跑赢收入，表明费用刚性未缓解，是现金紧张信号。

#### 路径2.3.B [4分 | 方向错配]
- 小标准2.3.B.1 [1分 | 完备性]：统计 `exp_mom>0 且 rev_mom≤0` 的出现率。
- 小标准2.3.B.2 [2分 | 精确性]：事件窗口占比=0.1154（容差±0.02），逐月：t-6=0.0、t-5=0.1429、t-4=0.1、t-3=0.1、t-2=0.1、t-1=0.2；需列举至少 1 个公司-月份示例（如 NET51366940438 在 t-1 出现错配）。
- 小标准2.3.B.3 [1分 | 结论性]：解释错配意味着费用刚性与收入波动叠加，加剧现金缺口。

#### 路径2.3.C [4分 | 成本结构替代]
- 小标准2.3.C.1 [1分 | 完备性]：若 Expense 缺失，需说明可使用 Expense + Cost of Revenue 作为总成本，与收入对比。
- 小标准2.3.C.2 [2分 | 精确性]：给出计算思路并验证：同样的 divergence 阈值在事件窗口下 share_div_gt15 仍≈0.29（容差±0.02）；若差异>5pp 需说明原因（如成本归类差异）。
- 小标准2.3.C.3 [1分 | 结论性]：强调成本替代口径与标准口径结论一致，可作为数据缺口时的备选方案。

———

## 需求3：高风险 vs 健康窗口对比与诊断洞察（最高 8分）

### 标准3.1：窗口聚合比较（最高 4分）

#### 路径3.1.A [4分 | 高风险 vs 健康]
- 小标准3.1.A.1 [1分 | 完备性]：分别在事件（52 行）与健康窗口（11 行）计算：收入波动、divergence>15%、WADO>40、overdue_up、exp_up_rev_down、动量指标。
- 小标准3.1.A.2 [2分 | 精确性]：事件窗口 share_rev_mom_gt20=0.5962、share_div_gt15=0.2885、share_wado_gt40=0.1923、share_overdue_up=0.4615；健康窗口对应 0.1818、0.0909、0.2727、0.0909（容差±0.02）；需列出表格或明细供复核。
- 小标准3.1.A.3 [1分 | 结论性]：阐明事件窗口指标显著高于健康窗口，尤其是收入波动与逾期动量，证明指标组合具备区分度。

#### 路径3.1.B [4分 | 高风险 vs 基线]
- 小标准3.1.B.1 [1分 | 完备性]：对比基线窗口（rel=-8/-7，共 7 行）的指标水平。
- 小标准3.1.B.2 [2分 | 精确性]：基线窗口 WADO>40 在 rel=-7 为 0.4、rel=-8 为 0.0；overdue_up、rev_mom 因缺少前期数据不可计算，需在结果中明确标注“环比不可得”。
- 小标准3.1.B.3 [1分 | 结论性]：说明即便只看绝对阈值，事件窗口 WADO>40 占比仍高于基线（0.1923 vs 0.0~0.4），侧面验证预警指标有效。

#### 路径3.1.C [4分 | 公司层聚合]
- 小标准3.1.C.1 [1分 | 完备性]：按公司计算事件窗口内的平均命中率，再对公司取均值。
- 小标准3.1.C.2 [2分 | 精确性]：事件窗口公司层平均（rev_vol_flag=0.5967、div15_flag=0.2867、wado40_flag=0.1900、overdue_up_flag=0.4600），健康窗口公司层平均（rev_vol_flag=0.1389、div15_flag=0.0833、wado40_flag=0.1944、overdue_up_flag=0.0556）（容差±0.02）；需提供 DataFrame 片段或导出表作为证据。
- 小标准3.1.C.3 [1分 | 结论性]：强调公司层聚合避免“大公司主导”偏差，健康窗口对比显示收入波动/逾期指标区分度最大。

### 标准3.2：逐月轨迹与现金流补充诊断（最高 4分）

#### 路径3.2.A [4分 | 逐月轨迹比对]
- 小标准3.2.A.1 [1分 | 完备性]：展示 rel=-6…-1 的关键指标轨迹：收入波动、divergence>15%、WADO>40、overdue_up、exp_up_rev_down。
- 小标准3.2.A.2 [2分 | 精确性]：事件窗口逐月值需与实测一致：
  * share_rev_mom_gt20：{0.2, 0.5714, 0.5, 0.8, 0.8, 0.5}
  * share_div_gt15：{0.0, 0.2857, 0.3, 0.3, 0.4, 0.3}
  * share_wado_gt40：{0.2, 0.2857, 0.0, 0.1, 0.3, 0.3}
  * share_overdue_up：{0.2, 0.1429, 0.7, 0.4, 0.4, 0.7}
  * share_exp_up_rev_down：{0.0, 0.1429, 0.1, 0.1, 0.1, 0.2}
  （容差均±0.05）。
- 小标准3.2.A.3 [1分 | 结论性]：指出 t-4～t-2 是指标齐升阶段，t-1 仍维持高位，验证“提前 2～3 个月预警”可行；需对比健康窗口对应月份（如健康 t-2：收入波动 0.2、WADO>40 0.2、overdue_up 0.2、divergence>15 为 0），以凸显差异。

#### 路径3.2.B [4分 | 现金流轨迹]
- 小标准3.2.B.1 [1分 | 完备性]：统计事件窗口 net_cash_flow、operating_cash_flow、predicted_next_month_cash_flow 的月均值与负值占比。
- 小标准3.2.B.2 [2分 | 精确性]：逐月均值须与实测一致：
  * t-6：net=540,606.25，oper=546,347.66，pred=557,507.78
  * t-5：net=691,855.09，oper=708,315.09，pred=687,274.03
  * t-4：net=634,123.60，oper=626,318.27，pred=635,635.24
  * t-3：net=657,234.87，oper=652,146.71，pred=684,008.12
  * t-2：net=593,160.18，oper=616,385.07，pred=576,507.02
  * t-1：net=599,312.90，oper=548,086.73，pred=621,748.31
  整体平均 net=622,775.62；三项负值占比均为 0（容差金额±1,000，比例±0.01）。
- 小标准3.2.B.3 [1分 | 结论性]：说明现金流均值维持正值，但 t-2 出现明显回落，与经营指标（收入波动、逾期）提前释放风险相呼应；结论需强调“单看净现金不足以预警”。

———

## 需求4：预警规则设计、验证与误报评估（最高 6分）

### 标准4.1：预警规则与组合逻辑（最高 3分）

#### 路径4.1.A [3分 | 两两组合规则]
- 小标准4.1.A.1 [1分 | 完备性]：提出 RuleA：滚动3个月内 |rev_mom|>20% 命中≥2 次且 div>15% 命中≥1 次；RuleB：RuleA 且最近3个月 WADO>40≥1 次或 overdue 连升≥2 次；RuleC：滚动3个月内 divergence>10% 命中≥2 次。
- 小标准4.1.A.2 [1分 | 精确性]：事件窗口公司层命中率均为 0.7（7/10，容差±0.05）；健康窗口命中率均为 0；需列出触发公司清单。
- 小标准4.1.A.3 [1分 | 结论性]：解释 RuleA/RuleB 侧重“召回”，RuleC 更严格，可对应黄色/红色预警；强调 RuleB 能覆盖 WADO/逾期动量风险。

### 标准4.2：命中率、最早触发与误报验证（最高 3分）

#### 路径4.2.A [3分 | 事件窗口验证]
- 小标准4.2.A.1 [1分 | 完备性]：统计每条规则的最早触发 rel 月份。
- 小标准4.2.A.2 [1分 | 精确性]：给出分布：
  * RuleA 首触发 {-4:3 家、-3:4 家、-2:6 家、-1:5 家}
  * RuleB 首触发 {-4:2 家、-3:3 家、-2:5 家、-1:4 家}
  * RuleC 首触发 {-3:2 家、-2:3 家、-1:4 家}
  （容差±1 家）；需附上 rel_month 与子公司对照表。
- 小标准4.2.A.3 [1分 | 结论性]：总结预警窗口主要集中在 t-4～t-2，可满足提前 2～3 个月提醒；部分公司在 t-4 已命中说明存在更早介入空间。

#### 路径4.2.B [3分 | 健康窗口误报率]
- 小标准4.2.B.1 [1分 | 完备性]：在健康窗口复算 RuleA/B/C 命中率。
- 小标准4.2.B.2 [1分 | 精确性]：健康窗口命中率全部为 0；说明样本仅 6 家子公司但完全通过“零误报”验证。
- 小标准4.2.B.3 [1分 | 结论性]：指出当前阈值组合误报极低，可视实际容忍度微调，如需要更高召回可放宽 RuleC 的滚动次数。

———

## 需求5：复现性、模型集成与业务落地（最高 6分）

### 标准5.1：流程复现与实现思路（最高 3分）

#### 路径5.1.A [3分 | 端到端流程说明]
- 小标准5.1.A.1 [1分 | 完备性]：列出流程：“仪表/损益读取→按子公司+月份去重→收入/费用聚合→计算 LAG/rel_month→构建事件/健康/基线窗口→衍生指标→规则评估→输出结论”。
- 小标准5.1.A.2 [1分 | 精确性]：说明关键实现细节：使用窗口函数计算 rel_month、rolling 指标；明确有效样本量（事件=52、健康=11、基线=7）；指明需记录命中次数以便复核。
- 小标准5.1.A.3 [1分 | 结论性]：强调流程可复用，窗口长度或阈值（如 40 天→35 天）可通过参数化调整；提醒操作日志需记录版本与时间戳。

#### 路径5.1.B [3分 | 指标折衷与口径说明]
- 小标准5.1.B.1 [1分 | 完备性]：梳理损益收入 vs 仪表收入、Expense vs Expense+COGS 等口径差异及适用场景。
- 小标准5.1.B.2 [1分 | 精确性]：在报告中明确列示两种口径下关键指标的差值（如收入波动 0.5962 vs 0.0962），并给出原因说明。
- 小标准5.1.B.3 [1分 | 结论性]：强调口径透明度有助于 CFO 与会计团队统一解读，防止跨团队误差。

### 标准5.2：运营执行与模型化建议（最高 3分）

#### 路径5.2.A [3分 | 监控与行动建议]
- 小标准5.2.A.1 [1分 | 完备性]：给出至少月度的监控节奏，并结合规则划分黄色/红色预警动作：如 RuleA 命中→冻结新增可变成本；RuleB 命中→3日内升级催收并评估现金缓冲。
- 小标准5.2.A.2 [1分 | 精确性]：行动需与指标一一对应：divergence>15% 连发→预算重估；overdue_up_recent3 命中→启动重点客户催收；WADO>40 连续2月→评估信用政策。
- 小标准5.2.A.3 [1分 | 结论性]：总结“经营指标领先现金金额”这一洞察，呼吁建立跨部门响应机制（财务+销售/交付）。

#### 路径5.2.B [3分 | 模型特征与验证]
- 小标准5.2.B.1 [1分 | 完备性]：建议将 rev_vol_roll3_ge2、div_gt15、wado_gt40、overdue_up_recent3、RuleA/B/C 命中、net_cash_flow 斜率等特征纳入现金流风险预测模型。
- 小标准5.2.B.2 [1分 | 精确性]：提出验证方案：以首次 High 作为正样本，在滚动训练中检验提前 2~3 个月的识别率；阈值可通过 ROC/PR 曲线或网格搜索微调。
- 小标准5.2.B.3 [1分 | 结论性]：说明模型可与规则共用：规则提供可解释的“强提醒”，模型提供概率评分，共同为 CFO 提供 2~3 个月的缓冲期规划。

———