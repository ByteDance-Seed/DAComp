# [总分 | 36分] 解决方案需满足以下四个核心需求：

  - 需求1：数据源确认与生命周期分层口径设定
  - 需求2：触达至活跃速度与留存/付费指标构建
  - 需求3：触达效率与序列路径分析
  - 需求4：洞察输出与策略落地

---

## 需求1：数据源确认与生命周期分层口径设定（最高可得 12分）

### 标准1.1：三表字段映射与主外键逻辑

#### 路径1.1.A [6分 | 事件+触达+人三表映射]
- 小标准1.1.A.1 [1分 | 完备性]：需完整列出 `klaviyo__events`（含 event_id、person_id、type、occurred_at、last_touch_campaign_id、variation_id、campaign_subject_line）、`klaviyo__person_campaign_flow`（person_id、last_touch_campaign_id、variation_id、first_event_at、last_event_at、count_received_email/opened_email/clicked_email、email_open_rate_touch、email_click_to_open_rate_touch）与 `klaviyo__persons`（person_id、email_open_rate、count_received_email/opened_email/clicked_email、active_retention_rate_week/month、paid_retained_month_count、timezone）字段；明确以 `person_id + last_touch_campaign_id + variation_id` 作为连接主键。
- 小标准1.1.A.2 [4分 | 精确性]：说明发送事件缺失时，采用 email_open 的 `occurred_at` 或 flow 的 `first_event_at` 近似触达时点；描述 `events → flow → persons` 的连接顺序，且需实际验证连接后共得到 4 条 person×campaign 记录、无重复膨胀（SQL 结果需满足 `COUNT(*)=4`）。必须展示锚点：`CMP0002` 组合的 `Σreceived=84`、`Σopened=45`、`Σclicked=18`，对应 `open_rate_touch=45/84=0.535714`、`click_rate_touch=18/84=0.214286`、`CTO=18/45=0.4000`（允许浮动 ≤0.0001）。
- 小标准1.1.A.3 [1分 | 结论性]：给出“结构可支撑后续分析”的判断，并点明局限：事件表仅 4 条记录（email_open=2、order=2），无 send/deliver/email_click 明细，因此后续结论均为探索性口径。

#### 路径1.1.B [6分 | 触达聚合主口径]
- 小标准1.1.B.1 [1分 | 完备性]：声明以 `klaviyo__person_campaign_flow` 为主表，`first_event_at / last_event_at` 近似触达窗口，`count_received_email/opened_email/clicked_email` 作为加权率的分母/分子，并从 `events` 引入 `campaign_subject_line`、关联 `persons` 取留存指标。
- 小标准1.1.B.2 [4分 | 精确性]：必须说明如何通过 `person_id+campaign_id+variation_id` 精确匹配避免一对多膨胀，且不得新增任何清洗步骤；需给出计算校验：`Σreceived`、`Σopened`、`Σclicked` 分别等于 `176/86/32`（折扣组合）与 `78/36/12`（新品组合），加权率满足 `open_rate_wt=86/176=0.488636`、`click_rate_wt=32/176=0.181818`、`CTO_wt=32/86=0.372093`（误差 ≤0.0001）。
- 小标准1.1.B.3 [1分 | 结论性]：指出此加权口径适用于样本稀疏、可稳定输出率，优势与局限需兼顾（优点：加权率稳定；局限：无法还原真实发送分母）。

#### 路径1.1.C [6分 | 事件+人两表兜底]
- 小标准1.1.C.1 [1分 | 完备性]：解释仅依赖 `events`+`persons` 时，如何使用 email_open 的 `occurred_at` 作为触达时间，`persons` 表的历史打开/点击/留存字段作为代理指标。
- 小标准1.1.C.2 [4分 | 精确性]：明确“先按 person_id 聚合 events，再关联 persons” 的流程，避免重复计数；锚点需核验：`persons.email_open_rate`（新品用户=0.41、折扣用户=0.42）、`click_rate_proxy = count_clicked_email / count_received_email`（分别为 0.0625 与 0.0758，误差 ≤0.0001）。
- 小标准1.1.C.3 [1分 | 结论性]：说明当触达汇总不可用时可作为备选，并强调该路径仅能输出方向性洞察。

### 标准1.2：生命周期分层与样本审计

#### 路径1.2.A [6分 | 事件时间窗口法]
- 小标准1.2.A.1 [1分 | 完备性]：定义生命周期层级：`冷启动=首次触达且历史无活跃记录`，`回流=距上一次活跃 ≥90 天后再次触达`；需结合 `events.email_open` 首次时间与 `persons.last_event_on`（或 flow 的 first_event_at）推导。
- 小标准1.2.A.2 [4分 | 精确性]：给出 SQL 逻辑：`first_touch = MIN(date(first_event_at))`，`prev_active = date(last_event_on)`，`days_gap = julianday(first_touch) - julianday(prev_active)`；复核结果：两位用户 `days_gap` 分别≈`771` 与 `948`，均≥90 天 → 归入“回流”；须说明未引入任何额外清洗。
- 小标准1.2.A.3 [1分 | 结论性]：输出分层样本量：`回流=2`、`冷启动=0`、`未分类=0`，并强调样本极度稀疏导致统计置信度有限。

#### 路径1.2.B [6分 | 触达汇总代理法]
- 小标准1.2.B.1 [1分 | 完备性]：当事件级不足时，以 flow 表的 `first_event_at/last_event_at/touch_span_days`、`count_received_email` 作为依据：`冷启动=person 首条 flow 记录`，`回流=与上一条记录间隔>90 天或 persons.active_retention_rate_month=0 后重新出现`。
- 小标准1.2.B.2 [4分 | 精确性]：说明需按 `person_id` 排序 flow 记录并计算相邻 `first_event_at` 间隔；校验锚点：`touch_span_days` 分别为 `81、139、168、191`，最大间隔(`191`)仍对应同一回流用户，满足>90 天；流程须保持原始字段、无清洗假设。
- 小标准1.2.B.3 [1分 | 结论性]：指出该代理分层适用于触达数据完整但事件稀缺的场景，并提醒可能高估冷启动数量（本库未出现冷启动）。

#### 路径1.2.C [6分 | 样本审计与覆盖评估]
- 小标准1.2.C.1 [1分 | 完备性]：统计 email_open 事件数、触达人数、campaign 数、主题分组、时间窗口的样本量。
- 小标准1.2.C.2 [4分 | 精确性]：锚点检查需满足：`events` 总计 `4` 条，`email_open=2`、`order=2`；最早时间 `2023-03-15 10:26:00`，最晚时间 `2024-01-14 17:55:00`；`person_campaign_flow` 行数 `4`、`distinct campaign=4`；`persons` 总人数 `1192`；若结果不同需提供同口径统计逻辑。
- 小标准1.2.C.3 [1分 | 结论性]：指出样本覆盖严重稀疏、后续分析需以探索性方向呈现，并建议扩充发送/行为数据。

---

## 需求2：触达至活跃速度与留存/付费指标构建（最高可得 12分）

### 标准2.1：从首次触达到活跃高峰的速度指标

#### 路径2.1.A [6分 | 事件级时长计算]
- 小标准2.1.A.1 [1分 | 完备性]：定义速度指标：`days_span = 订单发生时间 - 首次 email_open`、`active_months`、`paid_retained_month_count`、`paid_retention_rate_month`。
- 小标准2.1.A.2 [4分 | 精确性]：需给出 SQL 步骤：以 `email_open` 为起点，匹配同一 `person_id` 的订单事件，`days_span = ROUND(julianday(order) - julianday(open),1)`；锚点：新品样本 `days_span=73.4` 天、`active_months=8`、`paid_retained_month_count=3`、`paid_retention_rate_month=0.375`；折扣样本 `days_span=305.3` 天、`active_months=8`、`paid_retained_month_count=7`、`paid_retention_rate_month=0.875`（误差 ≤0.1）。
- 小标准2.1.A.3 [1分 | 结论性]：说明样本级结论仅供方向参考，需提醒大于 90 天的长周期并不具备统计显著性。

#### 路径2.1.B [6分 | 触达汇总时长法]
- 小标准2.1.B.1 [1分 | 完备性]：当订单事件缺失时，使用 flow 的 `first_event_at` 至 `last_event_at` 计算 `days_span = touch_span_days`，并以 `persons.active_retention_rate_month` 判定是否达到活跃。
- 小标准2.1.B.2 [4分 | 精确性]：锚点需对齐 flow 表：`CMP0001=81 天`、`CMP0002=139 天`、`CMP0012=168 天`、`CMP0016=191 天`；`touch_span_days` 需与 `last_event_at - first_event_at`（julianday 差）相符，误差 ≤1 天。
- 小标准2.1.B.3 [1分 | 结论性]：解释该方法可能低估真实活跃峰值，并要求阐明与事件级结果的偏差来源。

#### 路径2.1.C [6分 | 人群倾向代理]
- 小标准2.1.C.1 [1分 | 完备性]：说明使用 `persons.active_retention_rate_month` 与 `active_months` 估算活跃速度，例如 `est_active_months = active_retention_rate_month × active_months / 1.0`；需声明观察窗（本库以 `active_months` 字段=8 作为窗口）。
- 小标准2.1.C.2 [4分 | 精确性]：核验锚点：新品/故事用户 `est_active_months=0.8889×8≈7.11`、折扣用户 `0.875×8≈7.0`，且与 `active_months=8` 的偏差≤1 个月；不得新增清洗假设。
- 小标准2.1.C.3 [1分 | 结论性]：强调该方法仅能估计活跃倾向，需提示真实行为仍以事件/触达结果为准。

### 标准2.2：留存与付费指标体系

#### 路径2.2.A [6分 | 直接留存均值法]
- 小标准2.2.A.1 [1分 | 完备性]：在“时间窗口×主题”维度上输出 `avg_retention_week`、`avg_retention_month`、`paid_retained_month_count`、`paid_retention_rate_month`。
- 小标准2.2.A.2 [4分 | 精确性]：需对齐锚点：整体基线 `avg_retention_week=0.7871`、`avg_retention_month=0.8028`；折扣×工作日上午 `retention_week=1.0000`、`retention_month=1.0000`；新品×工作日上午 `0.9429/0.8889`；故事×工作日上午 `0.9429/0.8889`；允许误差 ≤0.0001。
- 小标准2.2.A.3 [1分 | 结论性]：指出高于基线的组合（如折扣×工作日上午 +0.2129pp），并强调结论非因果。

#### 路径2.2.B [6分 | 事件后窗口转化]
- 小标准2.2.B.1 [1分 | 完备性]：定义 `open→order` 的 7/30/90 日转化率，基于 email_open 时间窗口。
- 小标准2.2.B.2 [4分 | 精确性]：锚点核验：折扣样本 `7/30/90 日转化率=0`，新品样本 `7/30 日=0`、`90 日=1.0000`（误差 ≤0.0001）。
- 小标准2.2.B.3 [1分 | 结论性]：指出 90 日仅新品样本转化为 1，提醒样本稀疏需谨慎使用。

#### 路径2.2.C [6分 | 稳健均值/分位分析]
- 小标准2.2.C.1 [1分 | 完备性]：说明拟采用分位或截尾均值（如去掉上下 5%）以缓解极端值；若因样本量不足无法执行，需在方案中明确说明并给出替代分析。
- 小标准2.2.C.2 [4分 | 精确性]：若执行稳健统计需提供步骤（排序→截尾→平均）；若放弃执行，必须给出“不足以进行稳健估计”的证据（例如样本量仅 2），并提出替代（如直接报告原始均值）。
- 小标准2.2.C.3 [1分 | 结论性]：报告稳健统计对结论的影响；若未执行，需说明未能降低不确定性的风险。

---

## 需求3：触达效率与序列路径分析（最高可得 8分）

### 标准3.1：触达效率（Open/Click/CTO）交互面板

#### 路径3.1.A [6分 | 触达级加权汇总]
- 小标准3.1.A.1 [1分 | 完备性]：在“工作日/周末×主题”“上午/下午×主题”“节前/节后/非节×主题”面板上输出 `Σreceived`、`Σopened`、`Σclicked`、`open_rate_wt`、`click_rate_wt`、`CTO_wt`。
- 小标准3.1.A.2 [4分 | 精确性]：锚点需满足（误差 ≤0.0001）：折扣×工作日上午 `open=0.535714`、`click=0.214286`、`CTO=0.4000`；折扣×周末上午 `open=0.445652`、`click=0.152174`、`CTO=0.341463`；新品×工作日上午 `open=0.461538`、`click=0.153846`、`CTO=0.333333`；故事×工作日上午 `open=0.34375`、`click=0.109375`、`CTO=0.318182`；需注明“下午”与“节后3天”样本缺失。
- 小标准3.1.A.3 [1分 | 结论性]：指出折扣>新品>故事、工作日上午优于周末上午的方向性结论，并提醒样本极少。

#### 路径3.1.B [6分 | 人群均值代理]
- 小标准3.1.B.1 [1分 | 完备性]：计算每个面板组合的 `AVG(persons.email_open_rate)` 与 `AVG(persons.count_clicked_email / count_received_email)`。
- 小标准3.1.B.2 [4分 | 精确性]：锚点需满足（误差 ≤0.0001）：全体基线 `avg_email_open_rate=0.3537`、`avg_click_rate=0.0546`；折扣人群 `open≈0.42`、`click≈0.0758`；新品/故事人群 `open≈0.41`、`click≈0.0625`。
- 小标准3.1.B.3 [1分 | 结论性]：说明人群倾向与触达加权率方向一致，能辅证“折扣人群更易回应”。

#### 路径3.1.C [6分 | 事件级真实率（若有 send/deliver）]
- 小标准3.1.C.1 [1分 | 完备性]：若补充 send/deliver 事件，应输出真实分母的 open/click/CTO；当前库缺失需明确声明并提供替代方案（如沿用触达加权）。
- 小标准3.1.C.2 [4分 | 精确性]：若无法计算，应说明原因（事件列缺失）并给出可复现逻辑；若能计算则需提供 send/deliver→open/click 的统计、去重方法与锚点。
- 小标准3.1.C.3 [1分 | 结论性]：比较真实发送口径与代理口径的差异；若缺失则说明“暂以代理指标呈现，待补全数据”。

### 标准3.2：触达序列与 touch_type 作用

#### 路径3.2.A [6分 | 序列频次矩阵]
- 小标准3.2.A.1 [1分 | 完备性]：构建 person 维度 touch_type 序列（长度≤5），统计典型序列频次与首末触达类型。
- 小标准3.2.A.2 [4分 | 精确性]：锚点需匹配：唯一序列 `email→order`，覆盖 `2` 位用户；需展示生成方式（按 `occurred_at` 排序→窗口聚合）。
- 小标准3.2.A.3 [1分 | 结论性]：指出该序列对应的留存/转化表现（90 日转化：新品=1.0、折扣=0），并说明仍需更多触达类型以拓展路径分析。

#### 路径3.2.B [6分 | 状态转移/Markov 分析]
- 小标准3.2.B.1 [1分 | 完备性]：构建 touch_type 转移矩阵，计算 `P(next_touch | current_touch)`，并叠加打开/转化率。
- 小标准3.2.B.2 [4分 | 精确性]：锚点：`P(order | email)=1.0`（2 次 email 均转移至 order），需提供计算公式 `count(email→order)/count(email)`；其他转移缺失需标注为 0。
- 小标准3.2.B.3 [1分 | 结论性]：指出当前链路意味着“email 后直接订单”的探索性趋势，并强调需补充发送/点击事件以验证。

---

## 需求4：洞察输出与策略落地（最高可得 8分）

### 标准4.1：交互面板洞察与基线对比

#### 路径4.1.A [6分 | 结构化洞察输出]
- 小标准4.1.A.1 [1分 | 完备性]：至少输出三条“时间窗口×主题”结论，并配套 open/click/CTO/留存/转化指标。
- 小标准4.1.A.2 [4分 | 精确性]：每条洞察需引用锚点或差值，如“折扣×工作日上午：open=0.535714、click=0.214286、CTO=0.4000、retention_week=1.0，相对基线 +18.2pp/+15.97pp”；“新品×工作日上午：open=0.461538、retention_month=0.8889”；“折扣×周末上午：open=0.445652、click=0.152174”。
- 小标准4.1.A.3 [1分 | 结论性]：形成优先级排序（Top1=折扣×工作日上午，Top2=新品×工作日上午，备选=折扣×周末上午），并说明适用场景与样本风险。

#### 路径4.1.B [6分 | 基线对比法]
- 小标准4.1.B.1 [1分 | 完备性]：计算全体基线：`open=0.3537`、`click=0.0546`、`retention_week=0.7871`、`retention_month=0.8028`，并与关键组合逐项对比。
- 小标准4.1.B.2 [4分 | 精确性]：需给出差值（允许误差 ≤0.0001）：折扣×工作日上午 `Δopen=+0.1820`、`Δclick=+0.1597`、`Δretention_week=+0.2129`；新品×工作日上午 `Δopen=+0.1078`；故事×工作日上午 `Δopen=-0.0100`。 
- 小标准4.1.B.3 [1分 | 结论性]：指出值得扩大投放的组合（折扣×工作日上午）与需谨慎的组合（故事×工作日上午 open 低于基线），并提示样本量不足导致高不确定性。

### 标准4.2：执行建议与实验设计

#### 路径4.2.A [6分 | 因子化实验方案]
- 小标准4.2.A.1 [1分 | 完备性]：提出包含“时段（上午/下午）×日别（工作日/周末）×节前/节后 × 主题（折扣/新品/故事）”的实验设计，核心指标涵盖 open/click/CTO/7/30/90 日转化/留存。
- 小标准4.2.A.2 [4分 | 精确性]：建议每试验单元样本量≥300–500 次发送以检测 3–5pp 差异，说明随机化/分层策略（按 timezone 与历史活跃度分层）及至少 90 日观察窗，并确保与上述口径衔接。
- 小标准4.2.A.3 [1分 | 结论性]：明确待验证假设（如“折扣×工作日上午提升 CTO 至 ≥0.40”），要求以实验结果决定推广。

#### 路径4.2.B [6分 | 数据改进与监测闭环]
- 小标准4.2.B.1 [1分 | 完备性]：提出至少三项数据完善建议：补采集 send/deliver/email_click、引入本地化节日表、用 `persons.timezone` 进行本地化时段归类。
- 小标准4.2.B.2 [4分 | 精确性]：解释每项改进的增益：如 send/deliver 提供真实分母、节日表避免“节前3天”误判、时区本地化匹配用户行为；需说明兼容现有流程。
- 小标准4.2.B.3 [1分 | 结论性]：设定监测 KPI（例如目标 `CTO` 提升至 ≥0.38、订单转化 90 日>0.30）、明确季度复盘节奏与责任人，形成闭环。

---